# ToshibaLineController
ESP8266(ESPHOME) Based Line Controller for Toshiba air conditioner.
Decode Toshiba AB protocol for air conditioners with wired controllers.

Tested with remote control unit RBC-ASC11E.

- 线控协议及硬件电路参考了以下项目：
  - https://github.com/issalig/toshiba_air_cond

# 项目背景
东芝中央空调的室内机和室外机之间（室内机的U1/U2端子），可能采用了HBS（Home Bus System）协议，这里我没有集控网关，无法进行分析。看到了toshiba_air_cond(https://github.com/issalig/toshiba_air_cond) 这个项目之后，我开始参考这一项目，尝试在室内机的A/B端子，即连接到线控器的线缆上，增加一个运行ESPHOME固件的ESP8266设备，用于接入HomeAssistant，进行远程控制和状态读取。

在issalig的项目中，他描述了A/B端子的物理层协议，以及逆向分析出的控制协议等，给了我很大帮助。

但是根据issalig的描述，他的线控器A/B端子间电压高电平为15.6V，低电平为14V。和我这里测量到的电平有所不同。根据我的测试结果，随着负载电流增大，A/B端子的高电平电压会降低。因此靠稳压二极管可能没办法很好的适应不同负载的情况，因为我尝试使用LM393电压比较器，来搭建一个不受电压影响的电压比较电路。

# 物理层协议
东芝的A/B端子间，我实测开路电压为17.6V左右，连接一个线控器（工作电流30mA)后，端子电压为16.7V，打开线控器背光（工作电流50mA)后，端子电压降为16V左右。因此，我推测室内机内部应该是如下图的结构：一个18V（大概）的直流电源，具有比较大的内阻（比如100R）。当主机不发送数据时，总线电压为正常的电源电压，即18V，定义此状态为逻辑“1”。当总线发送逻辑“0”时，会将总线上加入一个负载，使得总线电流增大，由于电源有较大的内阻，所以路端电压随之下降（比如降低1V，为17V）。从机（线控器）同理。
![image](https://user-images.githubusercontent.com/11470789/123516352-3a9e6c00-d6ce-11eb-9339-bb1e90c46cd4.png)

# 串口协议
上述A/B端子总线上，数据传输使用UART协议，半双工，波特率2400，8数据位，偶校验。协议细节参考issalig的项目。

# 线控器数据接收电路（已验证）
原版线控器上，有一个LM393电压比较器，受此启发，我测试了以下接收电路，可以正常接收总线数据，同时不受总线负载情况影响。
电路原理如下：A/B端子的18V电压，由两路50K/10K电阻分压，以将电平降低到3.3V以内。其中一路直接接到比较器的正输入端，另一路通过肖特基二极管连接到比较器的负输入端。同时在二极管负极加入一个对地47uF电容，这样，当总线为高电平时，电容充电，接近分压后的高电平减去二极管压降（如2.61V-0.14V=2.47V)。总线低电平(分压后电压2.45)后，由于二极管的作用，电容电压不降低。这样，这一路电压就可以用作参考电压，当总线为逻辑1时，分压后电压为2.61V > 2.47V，比较器输出高电平；总线为逻辑0时，分压后电压为2.45V < 2.47V，比较器输出低电平。从而完成了由18V/17V到3.3V/0V的电平转换。由于二极管压降可能与比较器输入端高低电平的电压差接近，造成不正确的结果，可以调整R7/R8/R10/R11电阻的比例关系，将参考电压调整到比较器输入端压差一半的位置（(2.61V + 2.45V)/2 = 2.53V)，实现正常输出。

![image](https://user-images.githubusercontent.com/11470789/123516669-dc728880-d6cf-11eb-9e5f-ecef62c7ea25.png)

# 线控器数据发送电路（待验证）
根据A/B总线的原理，线控器需要发送逻辑0时，只要在A/B端子上增加一个负载，增大工作电流，使总线电压降低即可，这里我直接使用三极管来切换一个330Ω/1W的金属膜电阻。如以下电路：
![image](https://user-images.githubusercontent.com/11470789/123519601-ef408980-d6de-11eb-89bd-530977e79f6f.png)

# 总线供电方案（待验证）
本来考虑使用DC-DC器件实现18V到3.3V的降压转换，但使用LM2596实测发现，DC-DC器件开关过程会造成负载频繁变化，在总线上产生电压变化，干扰正常通信，使总线失效。所以我们需要使负载尽量恒定。

参考RBC-ASC11E电路板，此电路板使用了一个BA05三端稳压器，将18V左右的总线电压降低到5V。这里我们改用BA033，提供3.3V电压。


# 硬件设计
待上传


# 软件设计
待上传




